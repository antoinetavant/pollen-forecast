{% extends "base.html" %}
{% block content %}
{% load static %}

<div class="container mt-5">
    <h1 class="mb-4">Prévision du pollen</h1>

<form id="pollenForm" method="post" class="mt-4">
    {% csrf_token %}
    <div class="row g-3">
        <div class="col-md-4">
            <label for="date" class="form-label">Date:</label>
            <input type="date" id="date" name="date" value="{{ today }}" class="form-control">
        </div>

        <div class="col-md-4 position-relative">
            <label for="city_name" class="form-label">Nom de la ville:</label>
            <input type="text" id="city_name" name="city_name" value="{{ city_estimation }}" autocomplete="off" class="form-control">
            <ul id="city-suggestions" class="autocomplete-suggestions list-group"></ul>
        </div>

        <div class="col-md-4">
            <label for="polen_type" class="form-label">Type de pollen:</label>
            <select id="polen_type" name="polen_type" class="form-select">
                {% for pollen in list_of_pollen_names %}
                <option value="{{ pollen }}" {% if pollen == "Graminées" %}selected{% endif %}>
                    {{ pollen }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="mt-3 text-end">
            <button type="button" id="fetchData" class="btn btn-primary">Afficher la prévision</button>
    </div>
</form>
    <!-- Loading Spinner -->

<div id="loading-spinner" class="d-none text-center mt-3">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
<div id="chartjs-container" class="mt-4 card mx-auto" style="max-width: 80%; padding: 20px;">
    <div class="card-body">
        <canvas id="chartjs-canvas"></canvas>
    </div>
</div>
</div>

<script src="{% static 'cityforecast/scripts/chart.umd.min.js' %}"></script>
<script src="{% static 'cityforecast/scripts/meteoville.js' %}"></script>

<script>
// Autocomplete logic for city name
const cityInput = document.getElementById("city_name");
const suggestionsBox = document.createElement("ul");
suggestionsBox.classList.add("autocomplete-suggestions");
cityInput.parentNode.appendChild(suggestionsBox);

cityInput.addEventListener("input", function () {
    const query = cityInput.value;
    if (query.length > 1) {
        fetch(`/api/city-autocomplete/?q=${query}`)
            .then(response => response.json())
            .then(data => {
                suggestionsBox.innerHTML = "";
                data.forEach(city => {
                    const suggestion = document.createElement("li");
                    suggestion.textContent = city;
                    suggestion.classList.add("list-group-item", "list-group-item-action");
                    suggestion.addEventListener("click", function () {
                        cityInput.value = city;
                        suggestionsBox.innerHTML = "";
                    });
                    suggestionsBox.appendChild(suggestion);
                });
            });
    } else {
        suggestionsBox.innerHTML = "";
    }
});

// Hide suggestions when clicking outside
document.addEventListener("click", function (e) {
    if (!suggestionsBox.contains(e.target) && e.target !== cityInput) {
        suggestionsBox.innerHTML = "";
    }
});


// Call both Vega and Chart.js rendering functions when the page loads
document.addEventListener('DOMContentLoaded', function () {
    fetchAndRenderChartJS(); // Chart.js chart
});

// Add event listener for the button to fetch and render both charts on click
document.getElementById('fetchData').addEventListener('click', function () {
    fetchAndRenderChartJS(); // Chart.js chart
});
</script>
<style>
/* Add some basic styling for the autocomplete suggestions */
.autocomplete-suggestions {
    list-style-type: none;
    margin: 0;
    padding: 0;
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    position: absolute;
    background: white;
    z-index: 1000;
    width: 100%; /* Match the width of the input field */
    box-sizing: border-box; /* Ensure padding and border are included in the width */
}

.autocomplete-suggestions li {
    padding: 8px;
    cursor: pointer;
}

.autocomplete-suggestions li:hover {
    background-color: #f0f0f0;
}
#loading-spinner {
    margin-top: 20px;
}

#chartjs-container {
    margin: 0 auto; /* Center the chart horizontally */
    max-width: 80%; /* Set the maximum width of the chart */
    padding: 20px; /* Add padding around the chart */
}

#chartjs-canvas {
    height: 200px !important; /* Set the height of the Chart.js canvas */
}
</style>
{% endblock %}
