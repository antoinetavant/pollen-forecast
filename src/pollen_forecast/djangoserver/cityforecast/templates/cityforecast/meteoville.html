{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Prévision du pollen</h1>

<form id="pollenForm" method="post" class="mt-4">
    {% csrf_token %}
    <div class="row g-3">
        <div class="col-md-4">
            <label for="date" class="form-label">Date:</label>
            <input type="date" id="date" name="date" value="{{ today }}" class="form-control">
        </div>

        <div class="col-md-4 position-relative">
            <label for="city_name" class="form-label">Nom de la ville:</label>
            <input type="text" id="city_name" name="city_name" value="{{ city_estimation }}" autocomplete="off" class="form-control">
            <ul id="city-suggestions" class="autocomplete-suggestions list-group"></ul>
        </div>

        <div class="col-md-4">
            <label for="polen_type" class="form-label">Type de pollen:</label>
            <select id="polen_type" name="polen_type" class="form-select">
                {% for pollen in list_of_pollen_names %}
                <option value="{{ pollen }}" {% if pollen == "Graminées" %}selected{% endif %}>
                    {{ pollen }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="mt-3 text-end">
        <button type="submit" class="btn btn-primary">Afficher la prévision</button>
    </div>
</form>

<div id="chart-container" class="mt-4 card">
    <div class="card-body">
        <!-- Vega chart will be rendered here -->
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
<script>
document.getElementById('pollenForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;

    const formData = new FormData(form);

    fetch("", {
        method: "POST",
        body: formData,
        headers: {
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        const chartSpec = JSON.parse(data.chart);
        vegaEmbed('#chart-container', chartSpec, {actions: false});
    })
    .catch(error => {
        console.error('Error:', error);
    });
});

// Autocomplete logic for city name
const cityInput = document.getElementById("city_name");
const suggestionsBox = document.createElement("ul");
suggestionsBox.classList.add("autocomplete-suggestions");
cityInput.parentNode.appendChild(suggestionsBox);

cityInput.addEventListener("input", function () {
    const query = cityInput.value;
    if (query.length > 1) {
        fetch(`/api/city-autocomplete/?q=${query}`)
            .then(response => response.json())
            .then(data => {
                suggestionsBox.innerHTML = "";
                data.forEach(city => {
                    const suggestion = document.createElement("li");
                    suggestion.textContent = city;
                    suggestion.classList.add("list-group-item", "list-group-item-action");
                    suggestion.addEventListener("click", function () {
                        cityInput.value = city;
                        suggestionsBox.innerHTML = "";
                    });
                    suggestionsBox.appendChild(suggestion);
                });
            });
    } else {
        suggestionsBox.innerHTML = "";
    }
});

// Hide suggestions when clicking outside
document.addEventListener("click", function (e) {
    if (!suggestionsBox.contains(e.target) && e.target !== cityInput) {
        suggestionsBox.innerHTML = "";
    }
});
</script>
<style>
/* Add some basic styling for the autocomplete suggestions */
.autocomplete-suggestions {
    list-style-type: none;
    margin: 0;
    padding: 0;
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    position: absolute;
    background: white;
    z-index: 1000;
    width: 100%; /* Match the width of the input field */
    box-sizing: border-box; /* Ensure padding and border are included in the width */
}

.autocomplete-suggestions li {
    padding: 8px;
    cursor: pointer;
}

.autocomplete-suggestions li:hover {
    background-color: #f0f0f0;
}
</style>
{% endblock %}
