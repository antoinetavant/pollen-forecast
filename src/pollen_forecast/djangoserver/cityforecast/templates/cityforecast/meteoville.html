{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Prévision du pollen</h1>

<form id="pollenForm" method="post" class="mt-4">
    {% csrf_token %}
    <div class="row g-3">
        <div class="col-md-4">
            <label for="date" class="form-label">Date:</label>
            <input type="date" id="date" name="date" value="{{ today }}" class="form-control">
        </div>

        <div class="col-md-4 position-relative">
            <label for="city_name" class="form-label">Nom de la ville:</label>
            <input type="text" id="city_name" name="city_name" value="{{ city_estimation }}" autocomplete="off" class="form-control">
            <ul id="city-suggestions" class="autocomplete-suggestions list-group"></ul>
        </div>

        <div class="col-md-4">
            <label for="polen_type" class="form-label">Type de pollen:</label>
            <select id="polen_type" name="polen_type" class="form-select">
                {% for pollen in list_of_pollen_names %}
                <option value="{{ pollen }}" {% if pollen == "Graminées" %}selected{% endif %}>
                    {{ pollen }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="mt-3 text-end">
            <button type="button" id="fetchData" class="btn btn-primary">Afficher la prévision</button>
    </div>
</form>
    <!-- Loading Spinner -->

<div id="loading-spinner" class="d-none text-center mt-3">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
<div id="chart-container" class="mt-4 card mx-auto" style="max-width: 80%; padding: 20px;">
    <div class="card-body">
        <!-- Vega chart will be rendered here -->
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
<script>
    function fetchAndRenderChart() {

    const date = document.getElementById('date').value;
    const cityName = document.getElementById('city_name').value;
    const polenType = document.getElementById('polen_type').value;

    const spinner = document.getElementById('loading-spinner');
    spinner.classList.remove('d-none'); // Show the spinner

    fetch(`/api/pollen-data/?date=${date}&city_name=${cityName}&pollen_type=${polenType}`)
        .then(response => response.json())
        .then(data => {
            spinner.classList.add('d-none'); // Hide the spinner

            if (data.error) {
                alert(data.error);
                return;
            }

            // Prepare the data for Vega
            // const chartData = Object.keys(data).map(time => ({
            //    time: time,
            //    value: data[time][polenType],
            // }));
            console.log("Chart Data:", data); // Debug the data passed to Vega

// Prepare the Vega-Lite chart specification
            const chartSpec = {
                $schema: "https://vega.github.io/schema/vega-lite/v5.json",
                data: { values: data },
                mark: "bar",
                width: "container", // Use the full width of the container
                height: 200, // Set a fixed height for the chart

                encoding: {
                    x: { field: "time", type: "temporal", title: "Date" },
                    y: { field: polenType, type: "quantitative", title: polenType },
                    color: {
                        field: `${polenType}_niveau`,
                        type: "nominal",
                        scale: {
                            domain: data.level_names,
                            range: ["green", "gold", "orange", "red", "purple"]
                        },
                        title: "Niveau de risque"
                    },
                    tooltip: [ // Add tooltips for interactivity
                        { field: "time", type: "temporal", title: "Time" },
                        { field: polenType, type: "quantitative", title: polenType },
                        { field: `${polenType}_niveau`, type: "nominal", title: "Risk Level" }
                    ]
                },
                selection: { // Add zooming and panning
                    grid: {
                        type: "interval",
                        bind: "scales"
                    }
                }
            };

            // Render the chart
            vegaEmbed('#chart-container', chartSpec, { actions: false, renderer : "svg" });
        })
        .catch(error => {
            spinner.classList.add('d-none'); // Hide the spinner
            console.error('Error fetching data:', error);
            alert('An error occurred while fetching data.');
        });
};

// Call the function when the page loads
document.addEventListener('DOMContentLoaded', function () {
    fetchAndRenderChart();
});

// Add event listener for the button to fetch and render the chart on click
document.getElementById('fetchData').addEventListener('click', fetchAndRenderChart);

// Autocomplete logic for city name
const cityInput = document.getElementById("city_name");
const suggestionsBox = document.createElement("ul");
suggestionsBox.classList.add("autocomplete-suggestions");
cityInput.parentNode.appendChild(suggestionsBox);

cityInput.addEventListener("input", function () {
    const query = cityInput.value;
    if (query.length > 1) {
        fetch(`/api/city-autocomplete/?q=${query}`)
            .then(response => response.json())
            .then(data => {
                suggestionsBox.innerHTML = "";
                data.forEach(city => {
                    const suggestion = document.createElement("li");
                    suggestion.textContent = city;
                    suggestion.classList.add("list-group-item", "list-group-item-action");
                    suggestion.addEventListener("click", function () {
                        cityInput.value = city;
                        suggestionsBox.innerHTML = "";
                    });
                    suggestionsBox.appendChild(suggestion);
                });
            });
    } else {
        suggestionsBox.innerHTML = "";
    }
});

// Hide suggestions when clicking outside
document.addEventListener("click", function (e) {
    if (!suggestionsBox.contains(e.target) && e.target !== cityInput) {
        suggestionsBox.innerHTML = "";
    }
});
</script>
<style>
/* Add some basic styling for the autocomplete suggestions */
.autocomplete-suggestions {
    list-style-type: none;
    margin: 0;
    padding: 0;
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    position: absolute;
    background: white;
    z-index: 1000;
    width: 100%; /* Match the width of the input field */
    box-sizing: border-box; /* Ensure padding and border are included in the width */
}

.autocomplete-suggestions li {
    padding: 8px;
    cursor: pointer;
}

.autocomplete-suggestions li:hover {
    background-color: #f0f0f0;
}
#loading-spinner {
    margin-top: 20px;
}

#chart-container {
    margin: 0 auto; /* Center the chart horizontally */
    max-width: 80%; /* Set the maximum width of the chart */
    padding: 20px; /* Add padding around the chart */
}

.vega-embed {
    width: 100%; /* Ensure the chart takes up the full width of the container */
    height: 500px; /* Set a fixed height for the chart */

}
</style>
{% endblock %}
